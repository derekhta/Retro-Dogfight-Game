<!DOCTYPE html>
<html>
<head>
    <title>Retro Dogfight Online</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { 
            background: #000; color: #0f0; font-family: 'Courier New', monospace; 
            margin: 0; overflow: hidden; touch-action: none;
            display: flex; flex-direction: column; align-items: center;
        }
        canvas { border: 2px solid #fff; background: #000; max-width: 95vw; max-height: 75vh; margin-top: 5px; }
        #scoreboard { border: 2px solid #0f0; padding: 5px; width: 90vw; font-size: 14px; text-align: center; margin-top: 5px; }
        
        /* Joystick UI */
        #joy-base {
            position: absolute; bottom: 50px; left: 50px;
            width: 100px; height: 100px; background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3); border-radius: 50%;
            display: none; pointer-events: none;
        }
        #joy-stick {
            position: absolute; width: 40px; height: 40px;
            background: rgba(0, 255, 0, 0.4); border-radius: 50%;
            top: 30px; left: 30px;
        }
        #fireBtn {
            position: absolute; bottom: 40px; right: 40px;
            width: 100px; height: 100px; border: 4px solid #f00;
            border-radius: 50%; color: #f00; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            user-select: none; -webkit-user-select: none;
            background: rgba(255,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="ui-layer" style="margin-top: 50px; text-align: center;">
        <h1 style="color:white">DOGFIGHT ACE</h1>
        <input type="text" id="pName" placeholder="PILOT NAME" maxlength="8" style="padding:10px; background:#000; color:#0f0; border:1px solid #0f0;">
        <button onclick="initGame()" style="padding:15px 30px; background:#0f0; margin-top:20px;">TAKE OFF</button>
    </div>

    <div id="main-game" style="display:none;">
        <div id="scoreboard"><div id="aceList"></div></div>
        <canvas id="canvas" width="800" height="600"></canvas>
        
        <div id="joy-base"><div id="joy-stick"></div></div>
        <div id="fireBtn">FIRE</div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        let players = {}, bullets = [], explosions = [];
        let me = { x: 400, y: 300, angle: 0, speed: 3.5 };
        let turnInput = 0; // -1 (Full Left) to 1 (Full Right)
        let keys = {};

        // --- JOYSTICK LOGIC ---
        const joyBase = document.getElementById('joy-base');
        const joyStick = document.getElementById('joy-stick');
        let joyActive = false;
        let joyStart = { x: 0, y: 0 };

        document.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            // If touching left half of screen, start joystick
            if (touch.clientX < window.innerWidth / 2 && !joyActive) {
                joyActive = true;
                joyStart = { x: touch.clientX, y: touch.clientY };
                joyBase.style.display = 'block';
                joyBase.style.left = (joyStart.x - 50) + 'px';
                joyBase.style.top = (joyStart.y - 50) + 'px';
            }
        }, {passive: false});

        document.addEventListener('touchmove', (e) => {
            if (!joyActive) return;
            const touch = e.touches[0];
            let dx = touch.clientX - joyStart.x;
            
            // Limit joystick movement
            const dist = Math.min(Math.abs(dx), 50);
            const dir = dx > 0 ? 1 : -1;
            
            // Visual Update
            joyStick.style.left = (30 + (dir * dist * 0.6)) + 'px';
            
            // Granular turn value: -1 to 1
            turnInput = (dx / 50);
            if (turnInput > 1) turnInput = 1;
            if (turnInput < -1) turnInput = -1;
        }, {passive: false});

        document.addEventListener('touchend', () => {
            joyActive = false;
            joyBase.style.display = 'none';
            turnInput = 0;
        });

        // Fire Button
        const fireBtn = document.getElementById('fireBtn');
        fireBtn.addEventListener('touchstart', (e) => { e.preventDefault(); shoot(); });

        function shoot() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            bullets.push(createBullet());
            playSound('gun');
        }

        function playSound(type) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            if (type === 'gun') {
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            } else {
                osc.frequency.setValueAtTime(80, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(20, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            }
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.2);
        }

        function initGame() {
            socket.emit('joinGame', document.getElementById('pName').value || "ACE");
            document.getElementById('ui-layer').style.display = 'none';
            document.getElementById('main-game').style.display = 'block';
            loop();
        }

        window.onkeydown = (e) => { 
            if(e.key === 'ArrowLeft') turnInput = -1;
            if(e.key === 'ArrowRight') turnInput = 1;
            if(e.key === ' ') shoot(); 
        };
        window.onkeyup = (e) => { if(e.key.includes('Arrow')) turnInput = 0; };

        function createBullet() {
            return {
                x: me.x + Math.cos(me.angle) * 25, y: me.y + Math.sin(me.angle) * 25,
                vx: Math.cos(me.angle) * 10, vy: Math.sin(me.angle) * 10, life: 60
            };
        }

        function drawJet(p, color) {
            ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.angle);
            ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.beginPath();
            ctx.moveTo(20, 0); ctx.lineTo(-15, 0); 
            ctx.moveTo(5, 0); ctx.lineTo(-8, -18); ctx.lineTo(-12, -18); ctx.lineTo(-2, 0);
            ctx.moveTo(5, 0); ctx.lineTo(-8, 18); ctx.lineTo(-12, 18); ctx.lineTo(-2, 0);
            ctx.moveTo(-10, 0); ctx.lineTo(-18, -8); ctx.lineTo(-18, 8); ctx.closePath();
            ctx.stroke(); ctx.restore();
            ctx.fillStyle = "#fff"; ctx.fillText(p.name.toUpperCase(), p.x - 20, p.y - 25);
        }

        function loop() {
            // Apply granular turn: 0.08 is the max turn speed
            me.angle += (turnInput * 0.08);
            
            me.x = (me.x + Math.cos(me.angle) * me.speed + 800) % 800;
            me.y = (me.y + Math.sin(me.angle) * me.speed + 600) % 600;
            socket.emit('move', me);

            ctx.fillStyle = "black"; ctx.fillRect(0, 0, 800, 600);
            let scoreHTML = "ACES: ";
            for (let id in players) {
                let p = players[id];
                drawJet(p, id === socket.id ? "#fff" : "#0f0");
                scoreHTML += `${p.name}:${p.score} | `;
            }
            document.getElementById('aceList').innerHTML = scoreHTML;

            bullets.forEach((b, i) => {
                b.x += b.vx; b.y += b.vy; b.life--;
                if (b.life <= 0) bullets.splice(i, 1);
                ctx.fillStyle = "yellow"; ctx.fillRect(b.x, b.y, 4, 4);
                for (let id in players) {
                    if (id !== socket.id && Math.hypot(b.x - players[id].x, b.y - players[id].y) < 20) {
                        explosions.push({x: players[id].x, y: players[id].y, size: 5, life: 10});
                        playSound('boom'); socket.emit('bulletHit', id); bullets.splice(i, 1);
                    }
                }
            });

            explosions.forEach((e, i) => {
                ctx.strokeStyle = "white"; ctx.beginPath();
                for(let j=0; j<8; j++) {
                    let a = j * Math.PI/4;
                    ctx.moveTo(e.x, e.y); ctx.lineTo(e.x + Math.cos(a)*e.size, e.y + Math.sin(a)*e.size);
                }
                ctx.stroke(); e.size += 2; e.life--;
                if(e.life <= 0) explosions.splice(i, 1);
            });
            requestAnimationFrame(loop);
        }
        socket.on('updateState', (data) => players = data);
    </script>
</body>
</html>
